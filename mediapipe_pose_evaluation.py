# -*- coding: utf-8 -*-
"""Untitled9.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1BHIeO2131MKL2P5KxRJUJGIwzWSsDw1f
"""

# =====================================
# ğŸ§© 1ï¸âƒ£ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
# =====================================
!pip install mediapipe opencv-python numpy pandas moviepy

# =====================================
# ğŸ“‚ 2ï¸âƒ£ ì˜ìƒ ì—…ë¡œë“œ
# =====================================
from google.colab import files
uploaded = files.upload()
video_path = list(uploaded.keys())[0]
print(f"âœ… ì—…ë¡œë“œ ì™„ë£Œ: {video_path}")

import mediapipe as mp
import cv2
import pandas as pd
import numpy as np

# =====================================
# ğŸ§  3ï¸âƒ£ MediaPipeë¡œ í‚¤í¬ì¸íŠ¸ ì¶”ì¶œ
# =====================================
mp_pose = mp.solutions.pose
pose = mp_pose.Pose(static_image_mode=False,
                    model_complexity=1,
                    enable_segmentation=False,
                    min_detection_confidence=0.5)

cap = cv2.VideoCapture(video_path)
fps = cap.get(cv2.CAP_PROP_FPS)
keypoints_list = []
frame_idx = 0

while cap.isOpened():
    success, frame = cap.read()
    if not success:
        break

    frame_rgb = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
    results = pose.process(frame_rgb)

    if results.pose_landmarks:
        landmarks = results.pose_landmarks.landmark

        keypoints = {'frame': frame_idx}
        for i, lm in enumerate(landmarks):
            keypoints[f'x_{i}'] = lm.x
            keypoints[f'y_{i}'] = lm.y
            keypoints[f'z_{i}'] = lm.z
            keypoints[f'v_{i}'] = lm.visibility
        keypoints_list.append(keypoints)

    frame_idx += 1

cap.release()

df_key = pd.DataFrame(keypoints_list)
df_key.to_csv("/content/pose_keypoints.csv", index=False)
print(f"âœ… ì¢Œí‘œ ì¶”ì¶œ ì™„ë£Œ ({len(df_key)} í”„ë ˆì„, FPS={fps:.1f})")

# =====================================
# ğŸ“Š 4ï¸âƒ£ ìì„¸ í‰ê°€ + ê°ì  + 0.5ì´ˆ ì§€ì† ë¬¸ì œ ì²˜ë¦¬
# + ìì„¸ë³„ ì ìˆ˜/ë¬¸ì œ ë°œìƒ ìš”ì•½ ì¶”ê°€ âœ…
# =====================================
def analyze_posture_fixed(csv_path,
                          th_sh=0.04399,
                          th_head=0.01017):

    df = pd.read_csv(csv_path)
    VIS_THRESHOLD = 0.5
    k = 5  # ê°ì  ë¯¼ê°ë„
    frame_duration = 1.0 / fps
    problem_frames = []
    feedback_records = []

    # âœ… ì¹´í…Œê³ ë¦¬ë³„ ë¬¸ì œ í”„ë ˆì„ ì €ì¥
    shoulder_bad = []
    head_bad = []
    hand_bad = []

    def score_from_diff(diff, th):
        return 1.0 if diff <= th else max(1 - (diff - th) * k, 0)

    print("\nğŸ“Œ ì‚¬ìš© ì¤‘ì¸ ê³ ì • Threshold")
    print(f"ì–´ê¹¨ Y diff â†’ {th_sh:.5f}")
    print(f"ê³ ê°œ X diff â†’ {th_head:.5f}")

    for _, row in df.iterrows():

        def get_part(idx):
            return (row[f'x_{idx}'], row[f'y_{idx}']) if row[f'v_{idx}'] >= VIS_THRESHOLD else None

        L_sh, R_sh = get_part(11), get_part(12)
        Nose = get_part(0)
        L_hand, R_hand = get_part(16), get_part(15)

        # ì–´ê¹¨ ê¸°ìš¸ì–´ì§
        diff_sh = abs(L_sh[1] - R_sh[1]) if (L_sh and R_sh) else th_sh
        shoulder_score = score_from_diff(diff_sh, th_sh)
        if shoulder_score < 0.9:
            shoulder_bad.append(int(row["frame"]))

        # ê³ ê°œ ì¢Œ/ìš° ì ë¦¼
        if Nose and L_sh and R_sh:
            shoulder_mid_x = (L_sh[0] + R_sh[0]) / 2
            diff_head = abs(Nose[0] - shoulder_mid_x)
        else:
            diff_head = th_head
        head_score = score_from_diff(diff_head, th_head)
        if head_score < 0.9:
            head_bad.append(int(row["frame"]))

        # ì† ìœ„ì¹˜
        diff_hand = 0
        hand_score = 1.0
        if L_hand and R_hand and L_sh and R_sh:
            diff_hand = max(L_sh[1] - L_hand[1], R_sh[1] - R_hand[1])
            if diff_hand > 0:
                hand_score = max(1 - diff_hand * k, 0)
        if hand_score < 0.9:
            hand_bad.append(int(row["frame"]))

        avg_score = np.mean([shoulder_score, head_score, hand_score])

        feedback_records.append({
            "frame": int(row["frame"]),
            "shoulder": shoulder_score,
            "head_tilt": head_score,
            "hand": hand_score,
            "avg_score": avg_score,
            "shoulder_diff": diff_sh,  # ì¶”ê°€
            "head_diff": diff_head     # ì¶”ê°€
        })

        if avg_score < 0.9:
            problem_frames.append(int(row["frame"]))

    # ---------------------
    # ì—°ì† 0.5ì´ˆ ì´ìƒ ë¬¸ì œ êµ¬ê°„ ì •ë¦¬
    # ---------------------
    def merge(frames):
        sections = []
        if not frames:
            return sections
        start = frames[0]
        prev = start
        for f in frames[1:]:
            if f == prev + 1:
                prev = f
            else:
                sections.append((start, prev))
                start = f
                prev = f
        sections.append((start, prev))
        return [(s, e) for s, e in sections if (e - s + 1) * frame_duration >= 0.5]

    shoulder_sections = merge(shoulder_bad)
    head_sections = merge(head_bad)
    hand_sections = merge(hand_bad)

    df_out = pd.DataFrame(feedback_records)

    # âœ… ì „ì²´ ì ìˆ˜
    total_score = df_out["avg_score"].mean() * 100
    shoulder_mean = df_out["shoulder"].mean() * 100
    head_mean = df_out["head_tilt"].mean() * 100
    hand_mean = df_out["hand"].mean() * 100

    df_out.to_csv("/content/pose_feedback.csv", index=False)

    print("\nâœ… ë¶„ì„ ì™„ë£Œ!")
    print(f"ğŸ¯ ì „ì²´ ìì„¸ ì ìˆ˜: {total_score:.1f}ì ")
    print(f" â”œ ì–´ê¹¨ ì ìˆ˜: {shoulder_mean:.1f}")
    print(f" â”œ ê³ ê°œ ì ìˆ˜: {head_mean:.1f}")
    print(f" â”” ì† ì ìˆ˜: {hand_mean:.1f}")

    def print_section(label, sections):
        if sections:
            print(f"\nâš  {label} ë¬¸ì œ ì§€ì† êµ¬ê°„:")
            for s, e in sections:
                ts = s * frame_duration
                te = e * frame_duration
                dur = (e - s + 1) * frame_duration
                print(f"- {ts:.2f}ì´ˆ â†’ {te:.2f}ì´ˆ (ì´ {dur:.2f}ì´ˆ)")
        else:
            print(f"\nâœ… {label} ë¬¸ì œ ì—†ìŒ! ğŸ‘")

    print_section("ì–´ê¹¨", shoulder_sections)
    print_section("ê³ ê°œ", head_sections)
    print_section("ì†", hand_sections)

    return df_out, total_score, (shoulder_sections, head_sections, hand_sections)

# =====================================
# âœ… ì‹¤í–‰
# =====================================
feedback_df, total_score, problem_sections = analyze_posture_fixed("/content/pose_keypoints.csv")
feedback_df.head()

df_feedback = pd.read_csv("/content/pose_feedback.csv")
print(df_feedback.columns)
df_feedback.head()

import json
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np

# ============================================
# âœ… ë°ì´í„° ë¡œë“œ & í•„ìˆ˜ ì»¬ëŸ¼ ì¡´ì¬ í™•ì¸
# ============================================
df = pd.read_csv("/content/pose_feedback.csv")

required_cols = ["shoulder_diff", "head_diff", "hand"]
missing = [c for c in required_cols if c not in df.columns]

if missing:
    raise ValueError(f"âš  CSVì— í•„ìˆ˜ ì»¬ëŸ¼ ì—†ìŒ â†’ {missing}\n\n"
                     f"âœ… 'ì¢Œí‘œì°¨ì´ ë¶„ì„ ì½”ë“œ'ê°€ ë¨¼ì € ì‹¤í–‰ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.")

# ============================================
# ğŸ“ 1ï¸âƒ£ ë¬¸ì œë³„ ë©”ì‹œì§€ ì •ì˜
# ============================================
advice_map = {
    "shoulder": "{side} ì–´ê¹¨ê°€ ì˜¬ë¼ê°”ìŠµë‹ˆë‹¤. ì–‘ ì–´ê¹¨ë¥¼ ìˆ˜í‰ìœ¼ë¡œ ë§ì¶”ì–´ì£¼ì„¸ìš”.",
    "head_tilt": "ê³ ê°œê°€ {side}ë¡œ ê¸°ìš¸ì–´ ìˆìŠµë‹ˆë‹¤. ì²œì²œíˆ ì¤‘ì•™ìœ¼ë¡œ ë§ì¶°ì£¼ì„¸ìš”.",
    "hand": "ì†ì€ ì–´ê¹¨ ì•„ë˜ ìœ„ì¹˜ë¡œ ìœ ì§€í•´ì£¼ì„¸ìš”."
}

# ============================================
# 2ï¸âƒ£ React íƒ€ì„ë¼ì¸ìš© í”¼ë“œë°± JSON ìƒì„± (ì •ìì„¸ Threshold ê¸°ë°˜)
# ============================================
def generate_react_feedback_json(feedback_df, output_json_path, fps=30, min_duration=1.0,
                                 th_sh=0.04399, th_head=0.01017):
    alerts = []

    for col in ["shoulder", "head_tilt", "hand"]:
        if col == "shoulder":
            diff_col = "shoulder_diff"
            threshold = th_sh
        elif col == "head_tilt":
            diff_col = "head_diff"
            threshold = th_head
        else:
            diff_col = None

        # ë¬¸ì œ í”„ë ˆì„ íƒì§€
        if col in ["shoulder", "head_tilt"]:
            problem_idx = feedback_df.index[feedback_df[diff_col].abs() > threshold].tolist()
        else:
            problem_idx = feedback_df.index[feedback_df["hand"] < 1.0].tolist()

        if not problem_idx:
            continue

        # ì—°ì† êµ¬ê°„ ë¬¶ê¸°
        group_ids = (pd.Series(problem_idx).diff() > 1).cumsum()
        grouped = pd.DataFrame({"frame": problem_idx, "group": group_ids})

        for g_id, g_frames in grouped.groupby("group"):
            start_f = g_frames['frame'].min()
            end_f = g_frames['frame'].max()
            duration = (end_f - start_f) / fps

            if duration < min_duration:
                continue

            if col == "shoulder":
                mean_diff = feedback_df.loc[start_f:end_f, "shoulder_diff"].mean()
                side = "ì™¼ìª½" if mean_diff > 0 else "ì˜¤ë¥¸ìª½"
                message = advice_map[col].format(side=side)

            elif col == "head_tilt":
                mean_diff = feedback_df.loc[start_f:end_f, "head_diff"].mean()
                side = "ì™¼ìª½" if mean_diff > 0 else "ì˜¤ë¥¸ìª½"
                message = advice_map[col].format(side=side)

            else:
                message = advice_map[col]

            alerts.append({
                "start_time": round(start_f / fps, 2),
                "end_time": round(end_f / fps, 2),
                "issue": col,
                "message": message
            })

    json_data = {"feedback_timeline": alerts}

    with open(output_json_path, "w", encoding="utf-8") as f:
        json.dump(json_data, f, ensure_ascii=False, indent=2)

    print(f"âœ… JSON ì €ì¥ ì™„ë£Œ: {output_json_path}")
    print(f"ğŸš¨ ë¬¸ì œêµ¬ê°„: {len(alerts)}ê°œ")
    return json_data


# ============================================
# 3ï¸âƒ£ í”¼ë“œë°± JSON ìƒì„± ì‹¤í–‰
# ============================================
feedback_json = generate_react_feedback_json(
    feedback_df=df,
    output_json_path="/content/feedback_timeline.json",
    fps=30,
    min_duration=1.0
)

print("\nğŸ¯ ì˜ˆì‹œ ì¶œë ¥:")
print(json.dumps(feedback_json["feedback_timeline"][:5], ensure_ascii=False, indent=2))

# ============================================
# Graphs
# ============================================
with open("/content/feedback_timeline.json", "r", encoding="utf-8") as f:
    feedback_json = json.load(f)

fps = 30
time_sec = np.arange(len(df)) / fps

'''# Shoulder Graph
plt.figure(figsize=(14,4))
plt.plot(time_sec, df['shoulder_diff'], linewidth=2)
for alert in feedback_json['feedback_timeline']:
    if alert['issue'] == "shoulder":
        plt.axvspan(alert['start_time'], alert['end_time'], alpha=0.3)
plt.xlabel("Time (s)")
plt.ylabel("Left - Right (px)")
plt.title("Shoulder Height Difference")
plt.show()

# Head Tilt Graph
plt.figure(figsize=(14,4))
plt.plot(time_sec, df['head_diff'], linewidth=2)
for alert in feedback_json['feedback_timeline']:
    if alert['issue'] == "head_tilt":
        plt.axvspan(alert['start_time'], alert['end_time'], alpha=0.3)
plt.xlabel("Time (s)")
plt.ylabel("Head Tilt (px)")
plt.title("Head Tilt Difference")
plt.show()

# Hand Graph
plt.figure(figsize=(14,4))
plt.plot(time_sec, df['hand'], linewidth=2)
for alert in feedback_json['feedback_timeline']:
    if alert['issue'] == "hand":
        plt.axvspan(alert['start_time'], alert['end_time'], alpha=0.3)
plt.xlabel("Time (s)")
plt.ylabel("Hand Score")
plt.title("Hand Position Score")
plt.show()'''

# ============================================
# âœ… í‰ê·  ì ìˆ˜ íƒ€ì„ë¼ì¸ ì‹œê°í™”
# ============================================
avg_scores = df['avg_score'].values

plt.figure(figsize=(16, 5))
plt.plot(time_sec, avg_scores, linewidth=2)

# ì„ê³„ì„  í‘œì‹œ
plt.axhline(0.9, linestyle='--', linewidth=1)

# ë¬¸ì œêµ¬ê°„ í•˜ì´ë¼ì´íŠ¸ + ë¼ë²¨ë§(S/H/Hd)
for alert in feedback_json["feedback_timeline"]:
    s, e = alert["start_time"], alert["end_time"]
    label = ""
    if alert["issue"] == "shoulder": label = "S"
    elif alert["issue"] == "head_tilt": label = "H"
    elif alert["issue"] == "hand": label = "Hd"

    # ë°°ê²½ ìŒì˜
    plt.axvspan(s, e, alpha=0.3)

    # ë¼ë²¨ í‘œì‹œ (êµ¬ê°„ ì¤‘ê°„ ìœ„ì¹˜)
    mid = (s + e) / 2
    height = df.loc[int(mid * fps), "avg_score"]
    plt.text(mid, height + 0.03, label, fontsize=12, fontweight='bold')

plt.xlabel("Time (s)")
plt.ylabel("Average Score")
plt.ylim(0, 1.05)
plt.title("Posture Evaluation - Avg Score Timeline")
plt.grid(alpha=0.3)
plt.show()